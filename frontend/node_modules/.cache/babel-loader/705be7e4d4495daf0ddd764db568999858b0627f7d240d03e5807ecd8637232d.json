{"ast":null,"code":"var _jsxFileName = \"D:\\\\Uknord5he\\\\BH3\\\\dev\\\\diplomas\\\\frontend\\\\src\\\\hooks\\\\useAuth.js\",\n  _s = $RefreshSig$(),\n  _s2 = $RefreshSig$(),\n  _s3 = $RefreshSig$();\nimport React, { createContext, useCallback, useContext, useEffect, useState } from 'react';\nimport api from '../services/api';\n\n/** Бэк-энд как в исходном проекте */\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst EP_ME = '/me';\nconst EP_LOGIN = '/login';\nconst EP_LOGOUT = '/logout';\nconst STORAGE_KEY = 'auth/state/v1';\nfunction useAuthState() {\n  _s();\n  const [user, setUser] = useState(() => {\n    try {\n      return JSON.parse(localStorage.getItem(STORAGE_KEY) || 'null');\n    } catch {\n      return null;\n    }\n  });\n  const [ready, setReady] = useState(false); // чтобы UI мог дождаться проверки\n\n  const persist = u => {\n    setUser(u);\n    try {\n      if (u) localStorage.setItem(STORAGE_KEY, JSON.stringify(u));else localStorage.removeItem(STORAGE_KEY);\n    } catch {}\n  };\n  const isAuthed = !!(user && (user.email || user.isAdmin));\n  const isAdmin = !!(user !== null && user !== void 0 && user.isAdmin);\n\n  /** Возвращает true, если сервер подтвердил сессию */\n  const refresh = useCallback(async () => {\n    try {\n      const res = await api.get(EP_ME, {\n        // бьем по кэшу, чтобы не ловить 304\n        headers: {\n          'Cache-Control': 'no-cache',\n          Pragma: 'no-cache',\n          'If-Modified-Since': '0'\n        },\n        validateStatus: () => true\n      });\n      const {\n        status,\n        data\n      } = res;\n      if (status >= 200 && status < 300) {\n        var _ref, _data$email, _data$user, _data$user2;\n        const email = (_ref = (_data$email = data === null || data === void 0 ? void 0 : data.email) !== null && _data$email !== void 0 ? _data$email : data === null || data === void 0 ? void 0 : (_data$user = data.user) === null || _data$user === void 0 ? void 0 : _data$user.email) !== null && _ref !== void 0 ? _ref : null;\n        const admin = !!(data !== null && data !== void 0 && data.isAdmin || (data === null || data === void 0 ? void 0 : data.role) === 'admin' || (data === null || data === void 0 ? void 0 : (_data$user2 = data.user) === null || _data$user2 === void 0 ? void 0 : _data$user2.role) === 'admin');\n        if (email || admin) {\n          persist({\n            email,\n            isAdmin: admin\n          });\n          setReady(true);\n          return true;\n        }\n        // 2xx без полезных данных — считаем как гость\n        persist(null);\n        setReady(true);\n        return false;\n      }\n\n      // любые не-2xx (включая 304/401/403/404) — гость\n      persist(null);\n      setReady(true);\n      return false;\n    } catch {\n      persist(null);\n      setReady(true);\n      return false;\n    }\n  }, []);\n  useEffect(() => {\n    refresh();\n  }, [refresh]);\n\n  /** Логин подтверждаем только если /me после логина сказал «да» */\n  const login = async ({\n    email,\n    password\n  }) => {\n    const res = await api.post(EP_LOGIN, {\n      email,\n      password\n    }, {\n      validateStatus: () => true\n    });\n    const {\n      status,\n      data\n    } = res;\n    if (status >= 200 && status < 300) {\n      const ok = await refresh(); // только серверная проверка валидирует сессию\n      if (!ok) throw new Error('Login error');\n      return;\n    }\n    if (status === 401 || status === 403) {\n      throw new Error((data === null || data === void 0 ? void 0 : data.message) || 'Невірний логін або пароль');\n    }\n    throw new Error((data === null || data === void 0 ? void 0 : data.message) || 'Помилка авторизації');\n  };\n  const logout = async () => {\n    try {\n      await api.post(EP_LOGOUT, null, {\n        validateStatus: () => true\n      });\n    } catch {}\n    persist(null);\n  };\n  return {\n    user,\n    isAuthed,\n    isAdmin,\n    ready,\n    refresh,\n    login,\n    logout\n  };\n}\n_s(useAuthState, \"HPrDZ0vFspgvCuk9jG8dnrpEOUM=\");\nconst AuthContext = /*#__PURE__*/createContext({\n  user: null,\n  isAuthed: false,\n  isAdmin: false,\n  ready: false,\n  refresh: async () => {},\n  login: async () => {},\n  logout: async () => {}\n});\nexport function AuthProvider({\n  children\n}) {\n  _s2();\n  const auth = useAuthState();\n  return /*#__PURE__*/_jsxDEV(AuthContext.Provider, {\n    value: auth,\n    children: children\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 109,\n    columnNumber: 12\n  }, this);\n}\n_s2(AuthProvider, \"v5+xnRzRGgUkz6HrltagqFou1eE=\", false, function () {\n  return [useAuthState];\n});\n_c = AuthProvider;\nexport function useAuth() {\n  _s3();\n  return useContext(AuthContext);\n}\n_s3(useAuth, \"gDsCjeeItUuvgOWf1v4qoK9RF6k=\");\nexport default useAuth;\nvar _c;\n$RefreshReg$(_c, \"AuthProvider\");","map":{"version":3,"names":["React","createContext","useCallback","useContext","useEffect","useState","api","jsxDEV","_jsxDEV","EP_ME","EP_LOGIN","EP_LOGOUT","STORAGE_KEY","useAuthState","_s","user","setUser","JSON","parse","localStorage","getItem","ready","setReady","persist","u","setItem","stringify","removeItem","isAuthed","email","isAdmin","refresh","res","get","headers","Pragma","validateStatus","status","data","_ref","_data$email","_data$user","_data$user2","admin","role","login","password","post","ok","Error","message","logout","AuthContext","AuthProvider","children","_s2","auth","Provider","value","fileName","_jsxFileName","lineNumber","columnNumber","_c","useAuth","_s3","$RefreshReg$"],"sources":["D:/Uknord5he/BH3/dev/diplomas/frontend/src/hooks/useAuth.js"],"sourcesContent":["import React, {\r\n    createContext,\r\n    useCallback,\r\n    useContext,\r\n    useEffect,\r\n    useState,\r\n} from 'react';\r\nimport api from '../services/api';\r\n\r\n/** Бэк-энд как в исходном проекте */\r\nconst EP_ME = '/me';\r\nconst EP_LOGIN = '/login';\r\nconst EP_LOGOUT = '/logout';\r\n\r\nconst STORAGE_KEY = 'auth/state/v1';\r\n\r\nfunction useAuthState() {\r\n    const [user, setUser] = useState(() => {\r\n        try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || 'null'); }\r\n        catch { return null; }\r\n    });\r\n    const [ready, setReady] = useState(false); // чтобы UI мог дождаться проверки\r\n\r\n    const persist = (u) => {\r\n        setUser(u);\r\n        try {\r\n            if (u) localStorage.setItem(STORAGE_KEY, JSON.stringify(u));\r\n            else localStorage.removeItem(STORAGE_KEY);\r\n        } catch {}\r\n    };\r\n\r\n    const isAuthed = !!(user && (user.email || user.isAdmin));\r\n    const isAdmin = !!user?.isAdmin;\r\n\r\n    /** Возвращает true, если сервер подтвердил сессию */\r\n    const refresh = useCallback(async () => {\r\n        try {\r\n            const res = await api.get(EP_ME, {\r\n                // бьем по кэшу, чтобы не ловить 304\r\n                headers: { 'Cache-Control': 'no-cache', Pragma: 'no-cache', 'If-Modified-Since': '0' },\r\n                validateStatus: () => true,\r\n            });\r\n\r\n            const { status, data } = res;\r\n\r\n            if (status >= 200 && status < 300) {\r\n                const email = data?.email ?? data?.user?.email ?? null;\r\n                const admin = !!(data?.isAdmin || data?.role === 'admin' || data?.user?.role === 'admin');\r\n                if (email || admin) {\r\n                    persist({ email, isAdmin: admin });\r\n                    setReady(true);\r\n                    return true;\r\n                }\r\n                // 2xx без полезных данных — считаем как гость\r\n                persist(null);\r\n                setReady(true);\r\n                return false;\r\n            }\r\n\r\n            // любые не-2xx (включая 304/401/403/404) — гость\r\n            persist(null);\r\n            setReady(true);\r\n            return false;\r\n        } catch {\r\n            persist(null);\r\n            setReady(true);\r\n            return false;\r\n        }\r\n    }, []);\r\n\r\n    useEffect(() => { refresh(); }, [refresh]);\r\n\r\n    /** Логин подтверждаем только если /me после логина сказал «да» */\r\n    const login = async ({ email, password }) => {\r\n        const res = await api.post(EP_LOGIN, { email, password }, { validateStatus: () => true });\r\n        const { status, data } = res;\r\n\r\n        if (status >= 200 && status < 300) {\r\n            const ok = await refresh(); // только серверная проверка валидирует сессию\r\n            if (!ok) throw new Error('Login error');\r\n            return;\r\n        }\r\n        if (status === 401 || status === 403) {\r\n            throw new Error(data?.message || 'Невірний логін або пароль');\r\n        }\r\n        throw new Error(data?.message || 'Помилка авторизації');\r\n    };\r\n\r\n    const logout = async () => {\r\n        try { await api.post(EP_LOGOUT, null, { validateStatus: () => true }); } catch {}\r\n        persist(null);\r\n    };\r\n\r\n    return { user, isAuthed, isAdmin, ready, refresh, login, logout };\r\n}\r\n\r\nconst AuthContext = createContext({\r\n    user: null,\r\n    isAuthed: false,\r\n    isAdmin: false,\r\n    ready: false,\r\n    refresh: async () => {},\r\n    login: async () => {},\r\n    logout: async () => {},\r\n});\r\n\r\nexport function AuthProvider({ children }) {\r\n    const auth = useAuthState();\r\n    return <AuthContext.Provider value={auth}>{children}</AuthContext.Provider>;\r\n}\r\n\r\nexport function useAuth() {\r\n    return useContext(AuthContext);\r\n}\r\n\r\nexport default useAuth;\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}